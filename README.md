# Fast Bridge Service

Fast bridge is one-way semi-decentralized bridge created to speed up transfers from Near to Ethereum.

Repo with ethereum and near contracts, where you can read in more details how the Fast Bridge works: https://github.com/aurora-is-near/fast-bridge-protocol

Current repo is for LP-Relayer component of the Fast Bridge.

## Installation
### Requirements
Before running LP-Relayer you need to do the following preparation: 
1. You need **AWS account** and private key should be stored in ~/.aws/credentials file. It used for extracted events from NEAR (near/mod.rs part). https://docs.near.org/concepts/advanced/near-lake-framework https://aws.amazon.com/ It is NOT FREE
2. Install and run **redis**
3. Create the **Ethereum account**, get some ETH, buy supported tokens and increase allowance for the Eth ERC20 Fast Bridge Contract for supported tokens.
4. Create the **NEAR account**.
5. Install rainbow bridge. Clone `https://github.com/aurora-is-near/rainbow-bridge` and run `yarn install`

### Config
Also, for running LP-Relayer you need to write a proper config.

The config example you can find here: https://github.com/aurora-is-near/fast-bridge-service/blob/master/config.json.example
You can copy this config and field the correct values for you case. For the most
fields it is strait forward. 

Some comments about the config: 
1. For the values such as `${FAST_BRIDGE_ETHERSCAN_API_KEY}` you should setup environment variable, or
add the correspondent value into `.env` file or just change it into the real values in the config.
2. For `"rainbow_bridge_index_js_path"` and `"near_credentials_path"`
you should use the absolut path without `~`.

### Running
```
cargo build
cargo run -- --config <PATH_TO_CONFIG.JSON>
```

## Providing private key by vault
You can store relayer private keys for both Ethereum and Near in the vault. The vault
will be used in case if no argument with private key(`eth_secret`, `near_credentials`) is provided and correspondent
fields(`eth.private_key`,`near.near_credentials_path`) in the config are absent.

If you use vault, you should set the `VAULT_TOKEN` environment variable and  `vault_addr` field in the config.

### Vault set up
In this section, I will tell you how to locally install and set up the vault.

Instruction for vault installation: https://developer.hashicorp.com/vault/downloads

For running the server, write in the console:
```bash
$ vault server -dev
```
After running this command
you will see:
```bash
...
Root Token: <ROOT_TOKEN_VALUE>
...
```

This value you should save into
`VAULT_TOKEN` environment variable.

Before using the vault, first you
should set the Ethereum and Near Private
keys:
```bash
$ vault kv put secret/ethsignerSigningKey key=<ETH_PRIVATE_KEY>
$ vault kv put secret/nearsignerSigningKey key=<NEAR_PRIVATE_KEY> account_id=<NEAR_ACCOUNT_ID>
```

Now the vault is ready to use.

## Tests
The main test for checking the work of the whole system is integration test(`tests/integration_tests.rs`). 
This test runs the whole pipeline. In this section we will describe how to run it. 

First, you need to meet all the requirements from the 'requirements' section. 
The Eth account should be created in the Goerli network and you should
get some Goerli Eth to this account. Tokens will be minted automatically.

The private key for the NEAR test account should be stored in `~/.near-credentials/testnet/fastbridge.testnet.json`

### Environment variables
Also for running tests the following environment variables(or added into `.env` file) should be set up
* `FAST_BRIDGE_INFURA_PROJECT_ID` -- API KEY in Infura for eth url rpc
* `PATH_TO_RAINBOW_BRIDGE_REP` -- local path to cloned rainbow bridge  repo. For example `/home/olga/Aurora/rainbow-bridge`
* `FAST_BRIDGE_ETH_PRIVATE_KEY` -- private key for you testing ETH account in goerli network
* `FAST_BRIDGE_ETHERSCAN_API_KEY` -- API key in EtherSacan https://etherscan.io/apis

In the beginning of the `tests/integration_tests.rs` file you 
can find a few consts with the contract addresses you can 
change this values for you case. 

For running unit tests:
```bash
cargo test -- --test-threads 1
```

## How it works
The LP-Relayer consists of 5 main components, which executed concurrently:
1. `near/mod.rs` extracts new events generated by NearErc20FastBridge
2. `event_processor.rs` handle these events: submit transactions to EthErc20FastBridge and store the tx_hash to `PENDING_TRANSACTIONS` in redis.
3. `pending_transactions_worker.rs` checks the status of the pending transactions and when it is ready move tx_hash to `TRANSACTIONS` in redis.
4. `last_block.rs` extract the last block height from EthOnNearClient.
5. `unlock_token.rs` unlock tokens for ready transactions.

## Proof
### Manual generation
Generation proof for the given `tx_hash`
```
call [eth_getTransactionReceipt](https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_gettransactionreceipt) for `blockHash` and `to`.
call [eth_getLogs](https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_getlogs)(address=to, blockHash=blockHash) with accquired from previous step `blockHash` and `to`

In the reposnse find transaction_hash=tx_hash and get `logIndex`.

Then call 
index.js eth-to-near-find-proof '{"logIndex": log_index, "transactionHash": tx_hash}' --eth-node-url rpc_url
(log_index should be in dec format)
```
